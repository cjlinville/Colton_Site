<div id="map" style="width:100%;height:500px;border-radius:12px;"></div>

<link data-pjax rel="stylesheet" href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css">
<script data-pjax src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>

{% raw %}
<script data-pjax>
(function () {
  let map;

  function initMap() {
    const el = document.getElementById('map');
    if (!el) return;

    // if map already exists (PJAX), clean it up before re-init
    if (map && map.remove) map.remove();

    const style = {
      "version": 8,
      "sources": {
        "osm": {
          "type": "raster",
          "tiles": ["https://tile.openstreetmap.org/{z}/{x}/{y}.png"],
          "tileSize": 256,
          "attribution": "Â© OpenStreetMap contributors"
        }
      },
      "layers": [{ "id": "osm", "type": "raster", "source": "osm" }]
    };

    map = new maplibregl.Map({
      container: "map",
      style: style,
      center: [-111.8910, 40.7608],
      zoom: 9
    });
    window._mlmap = map;
    map.addControl(new maplibregl.NavigationControl(), "top-right");
    map.on("load", () => setTimeout(() => map.resize(), 0));
  }

  // first load
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initMap);
  } else {
    initMap();
  }

  // Hydejack PJAX load
  document.addEventListener("hy-push-state-after", initMap);
})();
</script>
{% endraw %}
